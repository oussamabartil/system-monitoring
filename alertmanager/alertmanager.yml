# Configuration AlertManager pour la gestion des alertes
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alertmanager@monitoring.local'
  smtp_auth_username: 'alertmanager@monitoring.local'
  smtp_auth_password: 'password'

# Configuration des templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Configuration du routage des alertes
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  routes:
    # Alertes CPU sp√©cifiques - notification imm√©diate √† l'utilisateur
    - match:
        alert_type: cpu_high
      receiver: 'cpu-alerts-user'
      group_wait: 0s
      repeat_interval: 5m

    # Alertes critiques - notification imm√©diate
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m

    # Alertes warning - notification group√©e
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 30m

# Configuration des r√©cepteurs d'alertes
receivers:
  # Webhook par d√©faut
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true

  # Alertes CPU sp√©cifiques pour l'utilisateur
  - name: 'cpu-alerts-user'
    email_configs:
      - to: 'oussamabartil.04@gmail.com'
        subject: '[ALERT CPU] Usage CPU √©lev√© - {{ .GroupLabels.alertname }}'
        body: |
          üö® ALERTE CPU CRITIQUE üö®

          {{ range .Alerts }}
          üìä R√©sum√©: {{ .Annotations.summary }}
          üìù Description: {{ .Annotations.description }}
          üñ•Ô∏è  Instance: {{ .Labels.instance }}
          ‚ö†Ô∏è  S√©v√©rit√©: {{ .Labels.severity }}
          üïê Heure: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

          Action recommand√©e: V√©rifiez imm√©diatement l'utilisation du CPU sur le syst√®me.
        send_resolved: true

  # Alertes critiques - Email + Slack
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@company.com'
        subject: '[CRITICAL] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Severity: {{ .Labels.severity }}
          {{ end }}
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#alerts-critical'
        title: 'Critical Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}

  # Alertes warning - Email seulement
  - name: 'warning-alerts'
    email_configs:
      - to: 'team@company.com'
        subject: '[WARNING] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Severity: {{ .Labels.severity }}
          {{ end }}

# Configuration de l'inhibition (suppression d'alertes redondantes)
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
